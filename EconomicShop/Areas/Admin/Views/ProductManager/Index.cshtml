@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

@section css{
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.2.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.5.0/css/select.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" />
}

@section DataTableScript{

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/select/1.5.0/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.3.0/js/responsive.bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.colVis.min.js"></script>
}

@section TinyEditor{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.1.0/tinymce.min.js" integrity="sha512-dr3qAVHfaeyZQPiuN6yce1YuH7YGjtUXRFpYK8OfQgky36SUfTfN3+SFGoq5hv4hRXoXxAspdHw4ITsSG+Ud/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
}

@section CDNScript{
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
}
<div>
    <div class="card">
        <div class="card-body">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProduct">Thêm sản phẩm</button>
            <button type="button" class="btn btn-warning">Xoá sản phẩm</button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="container">
                <br />
                <div style="width:100%; margin:0 auto;">
                    <table id="productTable" class="table table-striped table-bordered dt-responsive nowrap manager-table" width="100%" cellspacing="0">
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addProduct" tabindex="-1" aria-labelledby="ThemSanPham" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="ThemSanPham">Thêm sản phẩm</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm" enctype="multipart/form-data">
                        <div class="mb-2">
                            <label for="productName" class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="productName" name="Name" placeholder="Áo polo">
                        </div>

                        <div class="mb-2">
                            <label for="CategotyId" class="form-label">Chọn danh mục sản phẩm</label>
                            <select class="js-data-category-ajax form-select" aria-label="Default select example" id="CategoryId" name="CategoryId">
                                <option selected>Chọn danh mục sản phẩm</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="Image" class="form-label">Chọn hình sản phẩm</label>
                            <input class="form-control" type="file" id="Image" name="Image">
                        </div>

                        <div class="mb-2">
                            <label for="OriginalPrice" class="form-label">Giá gốc</label>
                            <input type="number" class="form-control" id="OriginalPrice" name="OriginalPrice" placeholder="90000">
                        </div>

                        <div class="mb-2">
                            <label for="Price" class="form-label">Giá bán</label>
                            <input type="number" class="form-control" id="Price" name="Price" placeholder="85000">
                        </div>

                        <div class="mb-2">
                            <label for="Quantity" class="form-label">Số lượng</label>
                            <input type="number" class="form-control" id="Quantity" name="Quantity" placeholder="110">
                        </div>

                        <div class="mb-2">
                            <label for="Content" class="form-label">Nội dung</label>
                            <input type="text" class="form-control" id="Content" name="Content" placeholder="Giảm 70% khi nhập mã ...">
                        </div>

                        <div class="mb-2">
                            <textarea id="Description" name="Description">Nhập mô tả sản phẩm</textarea>
                        </div>

                        <div class="mb-2">
                            <label for="Promotion" class="form-label">Giảm giá</label>
                            <input type="number" class="form-control" id="Promotion" name="Promotion" placeholder="20">
                        </div>

                        <div class="mb-2">
                            <label for="Warranty" class="form-label">Bảo hành (tháng)</label>
                            <input type="number" class="form-control" id="Warranty" name="Warranty" placeholder="12">
                        </div>

                        <div class="d-flex gap-2 mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="HomeFlag" name="HomeFlag" value="true">
                                <label class="form-check-label" for="HomeFlag">Hiển thị trang chủ</label>
                            </div>

                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="HotFlag" name="HotFlag" value="true">
                                <label class="form-check-label" for="HotFlag">Sản phẩm HOT</label>
                            </div>
                        </div>

                        <div class="mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="Status" name="Status" value="true">
                                <label class="form-check-label" for="Status">Kích hoạt sản phẩm</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="addProductForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="updateProduct" tabindex="-1" aria-labelledby="SuaSanPham" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="ThemSanPham">Sửa sản phẩm</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateProductForm" enctype="multipart/form-data">
                        <input type="hidden" name="Id" id="Id" value="" />
                        <div class="mb-2">
                            <label for="productName" class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="productName" name="Name" placeholder="Áo polo">
                        </div>

                        <div class="mb-2">
                            <label for="CategotyId" class="form-label">Chọn danh mục sản phẩm</label>
                            <select class="js-data-update-product-ajax form-select" aria-label="Default select example" id="CategoryId" name="CategoryId">
                                <option selected>Chọn danh mục sản phẩm</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="Image" class="form-label">Chọn hình sản phẩm</label>
                            <input class="form-control" type="file" id="Image" name="Image">
                        </div>

                        <div class="mb-2">
                            <label for="OriginalPrice" class="form-label">Giá gốc</label>
                            <input type="number" class="form-control" id="OriginalPrice" name="OriginalPrice" placeholder="90000">
                        </div>

                        <div class="mb-2">
                            <label for="Price" class="form-label">Giá bán</label>
                            <input type="number" class="form-control" id="Price" name="Price" placeholder="85000">
                        </div>

                        <div class="mb-2">
                            <label for="Quantity" class="form-label">Số lượng</label>
                            <input type="number" class="form-control" id="Quantity" name="Quantity" placeholder="110">
                        </div>

                        <div class="mb-2">
                            <label for="Content" class="form-label">Nội dung</label>
                            <input type="text" class="form-control" id="Content" name="Content" placeholder="Giảm 70% khi nhập mã ...">
                        </div>

                        <div class="mb-2">
                            <textarea id="Description" name="Description">Nhập mô tả sản phẩm</textarea>
                        </div>

                        <div class="mb-2">
                            <label for="Promotion" class="form-label">Giảm giá</label>
                            <input type="number" class="form-control" id="Promotion" name="Promotion" placeholder="20">
                        </div>

                        <div class="mb-2">
                            <label for="Warranty" class="form-label">Bảo hành (tháng)</label>
                            <input type="number" class="form-control" id="Warranty" name="Warranty" placeholder="12">
                        </div>

                        <div class="d-flex gap-2 mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="HomeFlag" name="HomeFlag" value="true">
                                <label class="form-check-label" for="HomeFlag">Hiển thị trang chủ</label>
                            </div>

                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="HotFlag" name="HotFlag" value="true">
                                <label class="form-check-label" for="HotFlag">Sản phẩm HOT</label>
                            </div>
                        </div>

                        <div class="mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="Status" name="Status" value="true">
                                <label class="form-check-label" for="Status">Kích hoạt sản phẩm</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="updateProductForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>

        $('.js-data-category-ajax').select2({
            theme: 'bootstrap-5',
            dropdownParent: $('#addProduct'),
            language: "vi",
            ajax: {
                url: "/Admin/ProductCategoryManager/get-all-by-select2",
                type: "get",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term// search term
                    }

                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                minimumInputLength: 2,
                width: 'resolve'
                // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
            }
        });

        tinymce.init({
            selector: '#Description',
            browser_spellcheck: true,
            contextmenu: false
        });

        // Prevent Bootstrap dialog from blocking focusin
        document.addEventListener('focusin', (e) => {
            if (e.target.closest(".tox-tinymce-aux, .moxman-window, .tam-assetmanager-root") !== null) {
                e.stopImmediatePropagation();
            }
        });

        var productTable = $('#productTable').DataTable({
            "processing": true, // for show progress bar
            "serverSide": true, // for process server side
            "filter": true, // this is for disable filter (search box)
            "orderMulti": false, // for disable multiple column at once
            "pageLength": 5,

            "ajax": {
                "url": "/Admin/ProductManager/LoadProduct",
                "type": "POST",
                "datatype": "json"
            },

            "columnDefs":
                [
                    { "width": "20%", "targets": [0, 1, 2, 3] },
                    {
                        orderable: false,
                        data: null,
                        defaultContent: '',
                        className: 'select-checkbox',
                        targets: [0]
                    }, {
                        "targets": [1],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        "targets": [2],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        "targets": [7],
                        "searchable": false,
                        "orderable": false
                    },
                    {
                        "targets": [8],
                        "searchable": false,
                        "orderable": false
                    },
                    {
                        "targets": [9],
                        "searchable": false,
                        "orderable": false
                    }],

            "columns": [
                {
                    orderable: false,
                    data: null,
                    defaultContent: '',
                    className: 'select-checkbox',
                    targets: [0]
                },
                { "data": "Id", "name": "Id", "title": "Id", "autoWidth": true },
                { "data": "Name", "name": "Name", "title": "Tên sản phẩm", "autoWidth": false, },
                {
                    data: null,
                    render: function (data, type, row) {
                        if (type === "display") {
                            return `<div class="round-img">
                                             <a href="#"><img class="rounded" src="${row.Image ? "/Images/Products/" + row.Image : "https://www.bootdey.com/img/Content/avatar/avatar5.png"}" alt=""></a>
                                        </div>`
                        }
                        return data

                    }, "title": "Hình ảnh", "autoWidth": true
                },
                { "data": "OriginalPrice", "name": "OriginalPrice", "title": "Giá gốc", "autoWidth": true },
                { "data": "Price", "name": "Price", "title": "Giá bán", "autoWidth": true },
                { "data": "Quantity", "name": "Quantity", "title": "Số lượng", "autoWidth": true },
                { "data": "CategoryName", "name": "CategoryName", "title": "Danh mục", "autoWidth": true },
                { "data": "Promotion", "name": "Promotion", "title": "Khuyến mãi", "autoWidth": true },
                {
                    data: null,
                    title: "Sửa",
                    render: function (data, type, full, meta) { return '<a class="btn btn-info" href="/Demo/Edit/' + full.Id + '">Edit</a>'; }
                },
                {

                    data: null,
                    title: "Xoá",
                    render: function (data, type, row) {
                        return "<a href='#' class='btn btn-danger' onclick=DeleteData('" + row.Id + "'); >Delete</a>";
                    }
                },

            ],
            select: {
                style: 'multi',
                selector: 'td:first-child'
            },
            order: [[1, 'asc']],
            dom: 'Bfrtip',
            buttons: ['pageLength', 'selectAll',
                'selectNone', {
                    extend: 'print',
                    download: 'open',
                    exportOptions: {
                        columns: ':visible'
                    },
                    customize: function (win) {
                        console.log($(win.document.body).find('table').eq(1))
                        // $(win.document.body)
                        //     .css('font-size', '10pt')
                        //     .prepend(
                        //         '<img src="http://datatables.net/media/images/logo-fade.png" style="position:absolute; top:0; left:0;" />'
                        //     );

                        $(win.document.body).find('table')
                            .addClass('table-bordered').removeClass("table-type-1")
                    },
                    messageTop: `<span class="h5 pt-3 d-block">THÔNG TIN GIA SƯ</span>`
                },
                'colvis',
            ],
            stateSave: true,
            responsive: true,
            aoColumnDefs: [{
                bSortable: false,
                aTargets: [0]
            }],
            orderCellsTop: true,
            fixedHeader: true,
            language: {
                url: "//cdn.datatables.net/plug-ins/1.12.1/i18n/vi.json",
                paginate: {
                    next: '»',
                    previous: '«'
                }
            }

        });

        $('#addProductForm').on('submit', (event) => {

            event.preventDefault();
            console.log($(event.target).serialize())
            $.ajax({
                type: "post",
                url: "/Admin/ProductManager/add-new",
                data: new FormData($(event.target)[0]),
                processData: false,
                contentType: false,
                dataType: "json",
                cache: false,
                success: function (data) {

                    if (data.status === "success") {

                        //
                        Toastify({
                            text: data.result,
                            duration: 5000,
                            close: true,
                            gravity: "top", // `top` or `bottom`
                            position: "right", // `left`, `center` or `right`
                            stopOnFocus: true, // Prevents dismissing of toast on hover
                            style: {
                                background: "linear-gradient(to right, #56C596, #7BE495)",
                            },
                            onClick: function () { } // Callback after click
                        }).showToast();
                    }
                    $(event.target)[0].reset();
                    $("#Name").focus();

                    productTable.ajax.reload(null, false);
                    console.log(data)
                },
                error: function (xhr, status, error) {
                    console.error(xhr);
                }
            });

        })

        $('#updateProductForm').on('submit', (event) => {

            event.preventDefault();
            console.log(new FormData($(event.target)[0]), "form data")
            $.ajax({
                type: "post",
                url: "/Admin/ProductManager/update-product",
                data: new FormData($(event.target)[0]),
                processData: false,
                contentType: false,
                dataType: "json",
                cache: false,
                success: function (data) {

                    if (data.status === "success") {
                        //
                        Toastify({
                            text: data.result,
                            duration: 5000,
                            close: true,
                            gravity: "top", // `top` or `bottom`
                            position: "right", // `left`, `center` or `right`
                            stopOnFocus: true, // Prevents dismissing of toast on hover
                            style: {
                                background: "linear-gradient(to right, #56C596, #7BE495)",
                            },
                            onClick: function () { } // Callback after click
                        }).showToast();
                    }

                    $(event.target)[0].reset();
                    $("#Name").focus();

                    productTable.ajax.reload(null, false);
                    console.log(data)
                },
                error: function (xhr, status, error) {
                    console.error(xhr);
                }
            });
        });
           

  

        $('#productTable tbody').on('click', 'tr', function () {
            var data = productTable.row(this).data();
            console.log(data)

            var updateModel = new bootstrap.Modal(document.getElementById('updateProduct'), {
                keyboard: false
            });
            updateModel.show();


            $('.js-data-update-product-ajax').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#updateProduct'),
                language: "vi",
                ajax: {
                    url: "/Admin/ProductCategoryManager/get-all-by-select2",
                    type: "get",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term// search term
                        }

                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    minimumInputLength: 2,
                    width: 'resolve'
                    // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
                }
            });

            $("#updateProduct .modal-body #Id").val(data.Id);
            $("#updateProduct .modal-body #productName").val(data.Name);
            $("#updateProduct .modal-body #OriginalPrice").val(data.OriginalPrice);
            $("#updateProduct .modal-body #Price").val(data.Price);
            $("#updateProduct .modal-body #Quantity").val(data.Quantity);
            $("#updateProduct .modal-body #Content").val(data.Content);
            tinymce.activeEditor.setContent(data.Description)
            $("#updateProduct .modal-body #Promotion").val(data.Promotion);
            $("#updateProduct .modal-body #Warranty").val(data.Warranty);
            $("#updateProduct .modal-body #HomeFlag").prop("checked", data.HomeFlag);
            $("#updateProduct .modal-body #HotFlag").prop("checked", data.HotFlag);
            $("#updateProduct .modal-body #Status").prop("checked", data.Status);
        });
    </script>

}